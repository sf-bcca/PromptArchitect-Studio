name: Deploy to Production

on:
  workflow_run:
    workflows: ["Docker Build & Push"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Self-Hosted Server
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TS_AUTHKEY }}

      - name: Get target IP via Tailscale
        id: get-ip
        run: |
          # Wait for Tailscale to stabilize
          sleep 5
          # Get the IP address of the target host using tailscale status
          TARGET_IP=$(sudo tailscale status --json | jq -r '.Peer | to_entries[] | select(.value.HostName=="${{ secrets.DEPLOY_HOST }}" or .value.DNSName=="${{ secrets.DEPLOY_HOST }}.") | .value.TailscaleIPs[0]' | head -1)
          if [ -z "$TARGET_IP" ] || [ "$TARGET_IP" = "null" ]; then
            echo "Could not resolve IP for ${{ secrets.DEPLOY_HOST }}"
            echo "Tailscale peers:"
            sudo tailscale status
            exit 1
          fi
          echo "Resolved IP: $TARGET_IP"
          echo "target_ip=$TARGET_IP" >> $GITHUB_OUTPUT

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Deploy via SSH
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.DEPLOY_USER }}@${{ steps.get-ip.outputs.target_ip }} << 'ENDSSH'
            set -e
            echo "ðŸš€ Starting deployment..."
            
            # Pull latest image from GHCR
            echo "ðŸ“¦ Pulling latest image..."
            docker pull ghcr.io/sf-bcca/promptarchitect-studio:latest
            
            # Stop and remove old container if exists
            echo "ðŸ›‘ Stopping old container..."
            docker stop promptarchitect-studio_web_1 2>/dev/null || true
            docker rm promptarchitect-studio_web_1 2>/dev/null || true
            
            # Start new container with the GHCR image
            echo "ðŸ”„ Starting new container..."
            docker run -d \
              --name promptarchitect-studio_web_1 \
              --restart always \
              -p 8084:80 \
              ghcr.io/sf-bcca/promptarchitect-studio:latest
            
            # Cleanup old images
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            echo "âœ… Deployment complete!"
          ENDSSH

      - name: Post deployment summary
        if: success()
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** \`${{ secrets.DEPLOY_HOST }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`ghcr.io/sf-bcca/promptarchitect-studio:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
